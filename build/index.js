(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.compose,n=window.wp.data,o=window.wp.element,i=window.wp.hooks,r=window.wp.i18n,s=window.wp.plugins,a=window.wp.apiFetch;var c=e.n(a);const l=window.wp.blocks,p=window.wp.blockEditor,d=window.wp.components,f=window.wp.url,u=window.ReactJSXRuntime,{Button:_,Notice:m,PanelBody:w,TextareaControl:h,ToggleControl:b}=d,y=d.__experimentalCodeEditor||d.CodeEditor,g=/^\s*<!--\s*wp:[\s\S]*-->\s*$/;function v(e){return!e||"string"!=typeof e||g.test(e)}function z(e){return"string"!=typeof e?"":e.trim()}function x(e){return Array.isArray(e)?e.filter(e=>e&&"object"==typeof e&&"string"==typeof e.html).map(e=>({html:z(e.html),capturedAt:"string"==typeof e.capturedAt?e.capturedAt:""})).filter(e=>""!==e.html&&!v(e.html)).slice(0,5):[]}function j(e,t){const n=z(e),o=x(t);if(""===n||v(n))return o;const i=o.filter(e=>e.html!==n);return[(r=n,{html:r,capturedAt:(new Date).toISOString()}),...i].slice(0,5);var r}function N(e){if(!e||"string"!=typeof e)return(0,r.__)("Sin fecha","sectioncore-pin-freeze");const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}function k(e){const t=z(e).replace(/\s+/g," ");return t?t.length<=96?t:`${t.slice(0,93)}...`:""}const C=function({attributes:e,clientId:t,isSelected:i,setAttributes:s}){const{wppf_html:a="",wppf_is_pinned:d=!1,wppf_history:g=[]}=e||{},[C,S]=(0,o.useState)(!1),[P,E]=(0,o.useState)(""),[T,L]=(0,o.useState)(a||""),[H,B]=(0,o.useState)(""),{block:D,postId:q}=(0,n.useSelect)(e=>({block:e("core/block-editor").getBlock(t),postId:e("core/editor").getCurrentPostId()}),[t]);if((0,o.useEffect)(()=>{L(a||"")},[a]),!i)return null;const M=x(g),R=e=>{E(""),B(""),L(e||"")};let A=(0,r.__)("Congela la salida del bloque para reemplazar su render dinámico.","sectioncore-pin-freeze");d&&(A=(0,r.__)("Este bloque está pineado y usa HTML estático.","sectioncore-pin-freeze")),C&&(A=(0,r.__)("Capturando HTML renderizado del bloque…","sectioncore-pin-freeze"));const I=T!==(a||"");return(0,u.jsx)(p.InspectorControls,{children:(0,u.jsxs)(w,{title:(0,r.__)("SectionCore Pin & Freeze","sectioncore-pin-freeze"),initialOpen:!0,children:[(0,u.jsx)(b,{label:(0,r.__)("Pin HTML","sectioncore-pin-freeze"),help:A,checked:d,onChange:async e=>{if(!e)return E(""),B(""),void s({wppf_is_pinned:!1});if(a&&!v(a))return E(""),B(""),void s({wppf_is_pinned:!0});S(!0),E("");try{const e=await(async()=>{if(!D)return"";const e=(0,l.getBlockType)(D.name),t=z((0,l.getBlockContent)(D));if(!e||"function"!=typeof e.save||v(t))try{const e={context:"edit"};q&&(e.post_id=Number(q));const t=(0,f.addQueryArgs)(`/wp/v2/block-renderer/${encodeURIComponent(D.name)}`,e),n=await c()({path:t,method:"POST",data:{attributes:D.attributes||{}}}),o=z(n?.rendered||"");if(o&&!v(o))return o}catch{}return t&&!v(t)?t:""})();if(e)return s({wppf_is_pinned:!0,wppf_html:e,wppf_history:j(a,M)}),void B((0,r.__)("HTML capturado y aplicado. Revisa el bloque pineado en el lienzo antes de guardar.","sectioncore-pin-freeze"));s({wppf_is_pinned:!1}),E((0,r.__)("No se pudo capturar HTML renderizado para este bloque. Intenta refrescar o guardar y reintentar.","sectioncore-pin-freeze"))}finally{S(!1)}},disabled:C}),!!P&&(0,u.jsx)(m,{status:"warning",isDismissible:!1,className:"wppf-block-capture-notice",children:(0,u.jsx)("p",{children:P})}),d&&(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("p",{className:"wppf-inspector-help",children:(0,r.__)("HTML estático del bloque pineado:","sectioncore-pin-freeze")}),y?(0,u.jsx)(y,{value:T,onChange:R,language:"html",className:"wppf-code-editor"}):(0,u.jsx)(h,{label:(0,r.__)("Frozen HTML","sectioncore-pin-freeze"),value:T,onChange:R,rows:12,className:"wppf-code-editor-fallback"}),(0,u.jsx)("div",{className:"wppf-html-actions",children:(0,u.jsx)(_,{variant:"primary",onClick:()=>{const e=T||"";e!==(a||"")&&(E(""),s({wppf_html:e,wppf_history:j(a,M)}),B((0,r.__)("Cambios aplicados. Revisa el bloque pineado actualizado en el lienzo.","sectioncore-pin-freeze")))},disabled:!I||C,children:(0,r.__)("Aplicar cambios","sectioncore-pin-freeze")})}),!!H&&(0,u.jsx)(m,{status:"success",isDismissible:!1,className:"wppf-block-capture-notice",children:(0,u.jsx)("p",{children:H})}),(0,u.jsxs)("div",{className:"wppf-block-history",children:[(0,u.jsx)("p",{className:"wppf-inspector-help",children:(0,r.__)("Historial del bloque (últimas 5 versiones aplicadas):","sectioncore-pin-freeze")}),M.length>0?(0,u.jsx)("ul",{className:"wppf-block-history-list",children:M.map((e,t)=>(0,u.jsxs)("li",{className:"wppf-block-history-item",children:[(0,u.jsxs)("div",{className:"wppf-block-history-meta",children:[(0,u.jsx)("span",{className:"wppf-block-history-date",children:N(e.capturedAt)}),(0,u.jsx)("code",{className:"wppf-block-history-excerpt",children:k(e.html)||(0,r.__)("(Sin contenido)","sectioncore-pin-freeze")})]}),(0,u.jsx)(_,{variant:"secondary",size:"small",onClick:()=>(e=>{const t=M[e];if(!t)return;if(t.html===(a||""))return L(t.html),void B((0,r.__)("Esta versión ya está aplicada.","sectioncore-pin-freeze"));const n=j(a,M.filter((t,n)=>n!==e));E(""),s({wppf_html:t.html,wppf_history:n}),L(t.html),B((0,r.__)("Versión del historial restaurada y aplicada.","sectioncore-pin-freeze"))})(t),disabled:C,children:(0,r.__)("Restaurar","sectioncore-pin-freeze")})]},`${e.capturedAt||"entry"}-${t}`))}):(0,u.jsx)("p",{className:"wppf-block-history-empty",children:(0,r.__)("Aún no hay historial para este bloque.","sectioncore-pin-freeze")})]})]})]})})},S=function({className:e="",label:t="",actionLabel:n="",onRequestSelect:o,onRequestUnpin:i}){const s=Boolean(i&&n),a=Boolean(i&&!s),c=Boolean(o&&!a),l=Boolean(a||c),p=e=>{l&&(e.preventDefault(),e.stopPropagation(),a&&i?i():c&&o&&o())};return(0,u.jsx)("div",{className:`wppf-pin-overlay ${e}`.trim(),role:l?"button":void 0,tabIndex:l?0:void 0,onClick:l?p:void 0,onKeyDown:l?e=>{l&&("Enter"!==e.key&&" "!==e.key||(e.preventDefault(),p(e)))}:void 0,children:(0,u.jsxs)("div",{className:"wppf-pin-overlay__content",children:[(0,u.jsxs)("span",{className:"wppf-pin-overlay__title-row",children:[(0,u.jsx)("span",{className:"wppf-pin-overlay__icon","aria-hidden":"true",children:(0,u.jsx)("svg",{viewBox:"0 0 24 24",focusable:"false",children:(0,u.jsx)("path",{d:"M16 9V4l1-1V2H7v1l1 1v5l-2 2v1h5v7l1 1 1-1v-7h5v-1l-2-2z"})})}),(0,u.jsx)("span",{className:"wppf-pin-overlay__title",children:t||(0,r.__)("Este contenido está pineado.","sectioncore-pin-freeze")})]}),!s&&(0,u.jsx)("span",{className:"wppf-pin-overlay__subtitle",children:(0,r.__)("Haz clic para despinearlo.","sectioncore-pin-freeze")}),s&&(0,u.jsx)("button",{type:"button",className:"wppf-pin-overlay__button",onClick:e=>{e.preventDefault(),e.stopPropagation(),i&&i()},children:n})]})})},P=window.wp.date,E=window.wp.editPost,T="_wppf_is_post_pinned",L="_wppf_post_html";function H(){const e=(0,n.useSelect)(e=>e("core/editor").getEditedPostAttribute("meta")||{},[]),{editPost:t}=(0,n.useDispatch)("core/editor"),o=Boolean(e[T]),i=e[L]||"",r=n=>{t({meta:{...e,...n}})};return{html:i,isPinned:o,pinCurrentState:()=>{const e=(0,n.select)("core/editor").getEditedPostContent()||"";r({[T]:!0,[L]:e})},setHtml:e=>{r({[L]:e||""})},setPinned:e=>{r({[T]:Boolean(e)})}}}const{Button:B,Notice:D,SelectControl:q,Spinner:M,TabPanel:R,TextareaControl:A,ToggleControl:I}=d,F=d.__experimentalCodeEditor||d.CodeEditor;function O(){return window?.wppfEditorSettings||{}}async function U(e,t){const n=O().ajaxUrl||window?.ajaxurl||"";if(!n)throw new Error((0,r.__)("No se encontró la URL de AJAX para SectionCore Pin & Freeze.","sectioncore-pin-freeze"));const o=new window.FormData;o.append("action",e),o.append("nonce",O().nonce||""),Object.entries(t||{}).forEach(([e,t])=>{const n=null==t?"":String(t);o.append(e,n)});const i=await window.fetch(n,{method:"POST",credentials:"same-origin",body:o});if(!i.ok)throw new Error((0,r.sprintf)(/* translators: %d: HTTP status code */ /* translators: %d: HTTP status code */
(0,r.__)("Error de red al procesar la petición (%d).","sectioncore-pin-freeze"),i.status));let s=null;try{s=await i.json()}catch{throw new Error((0,r.__)("La respuesta del servidor no es válida. Verifica si el sitio está en mantenimiento o inaccesible.","sectioncore-pin-freeze"))}if(!s?.success)throw new Error(s?.data?.message||(0,r.__)("No se pudo completar la operación de pinning.","sectioncore-pin-freeze"));return s.data||{}}function $(e){const t=e?._embedded?.author?.[0]?.name;return t||(0,r.__)("Autor desconocido","sectioncore-pin-freeze")}const V=function(){const{html:e,isPinned:t,setHtml:i,setPinned:s}=H(),[a,c]=(0,o.useState)("editor"),[l,p]=(0,o.useState)(!1),[d,f]=(0,o.useState)(!1),[_,m]=(0,o.useState)(!1),[w,h]=(0,o.useState)(""),[b,y]=(0,o.useState)(""),g=(0,n.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),v=O().snapshotPostType||"wppf_snapshot",z=(0,o.useMemo)(()=>({per_page:20,parent:g,order:"desc",orderby:"date",context:"edit",_embed:!0}),[g]),x=(0,n.useSelect)(e=>g?(e("core").getEntityRecords("postType",v,z)||[]).filter(e=>Number(e?.parent)===Number(g)).slice(0,5):[],[g,v,z]),j=(0,n.useSelect)(e=>!!g&&e("core/data").isResolving("core","getEntityRecords",["postType",v,z]),[g,v,z]),N=Boolean(O().canUnfilteredHtml),k=O().captureSelector||"#content",C=()=>{y(""),h("")},S=async()=>{if(C(),g){p(!0);try{const e=await U("wppf_fetch_frontend",{post_id:g});i(e.html||""),h((0,r.__)("Contenido capturado desde frontend. Revísalo y guarda el pin.","sectioncore-pin-freeze"))}catch(e){y(e?.message||(0,r.__)("Error al capturar frontend.","sectioncore-pin-freeze"))}finally{p(!1)}}else y((0,r.__)("No se encontró el ID del contenido actual.","sectioncore-pin-freeze"))},T=async()=>{if(C(),g){f(!0);try{let t=e||"";if("editor"===a&&(t=(0,n.select)("core/editor").getEditedPostContent()||"",i(t)),!t.trim())throw new Error((0,r.__)("No hay HTML para pinear.","sectioncore-pin-freeze"));const o=await U("wppf_save_post_pin",{post_id:g,html:t,is_pinned:1});o?.html&&i(o.html),s(!0),h(o?.message||(0,r.__)("Pin guardado correctamente.","sectioncore-pin-freeze"))}catch(e){y(e?.message||(0,r.__)("Error guardando el pin.","sectioncore-pin-freeze"))}finally{f(!1)}}else y((0,r.__)("No se encontró el ID del contenido actual.","sectioncore-pin-freeze"))};return(0,u.jsxs)(E.PluginDocumentSettingPanel,{name:"wppf-post-pinning",title:(0,r.__)("Post Pinning","sectioncore-pin-freeze"),className:"wppf-post-panel",children:[(0,u.jsx)(I,{label:(0,r.__)("Pin complete post HTML","sectioncore-pin-freeze"),help:t?(0,r.__)("El frontend mostrará el HTML estático guardado en meta.","sectioncore-pin-freeze"):(0,r.__)("Permite reemplazar todo el contenido de frontend por HTML estático.","sectioncore-pin-freeze"),checked:t,onChange:s}),t&&(0,u.jsx)(D,{status:"warning",isDismissible:!1,children:(0,r.__)("La edición visual queda bloqueada mientras esta entrada/página esté pineada.","sectioncore-pin-freeze")}),!N&&(0,u.jsx)(D,{status:"info",isDismissible:!1,children:(0,r.__)("Tu rol no tiene unfiltered_html. El HTML se sanitizará automáticamente al guardar y renderizar.","sectioncore-pin-freeze")}),b&&(0,u.jsx)(D,{status:"error",isDismissible:!0,onRemove:()=>y(""),children:b}),w&&(0,u.jsx)(D,{status:"success",isDismissible:!0,onRemove:()=>h(""),children:w}),(0,u.jsx)(R,{className:"wppf-post-tabs",tabs:[{name:"capture",title:(0,r.__)("Capture","sectioncore-pin-freeze")},{name:"history",title:(0,r.__)("Pin History","sectioncore-pin-freeze")}],children:t=>"history"===t.name?j?(0,u.jsx)("div",{className:"wppf-history-loading",children:(0,u.jsx)(M,{})}):x.length?(0,u.jsx)("ul",{className:"wppf-history-list",children:x.map(e=>{return(0,u.jsxs)("li",{className:"wppf-history-item",children:[(0,u.jsxs)("div",{className:"wppf-history-item__meta",children:[(0,u.jsx)("strong",{children:(t=e.date,t?(0,P.dateI18n)("Y-m-d H:i",t):(0,r.__)("Sin fecha","sectioncore-pin-freeze"))}),(0,u.jsx)("span",{children:$(e)})]}),(0,u.jsx)(B,{variant:"secondary",onClick:()=>(async e=>{if(C(),!g)return void y((0,r.__)("No se encontró el ID del contenido actual.","sectioncore-pin-freeze"));const t=function(e){return e?.content?.raw?e.content.raw:e?.content?.rendered?e.content.rendered:""}(e);if(t){m(!0);try{const e=await U("wppf_save_post_pin",{post_id:g,html:t,is_pinned:1,skip_snapshot:1});i(e?.html||t),s(!0),h((0,r.__)("Snapshot restaurado y meta actualizada correctamente.","sectioncore-pin-freeze"))}catch(e){y(e?.message||(0,r.__)("No se pudo restaurar el snapshot.","sectioncore-pin-freeze"))}finally{m(!1)}}else y((0,r.__)("El snapshot seleccionado no contiene HTML utilizable.","sectioncore-pin-freeze"))})(e),disabled:_||d||l,children:(0,r.__)("Restaurar","sectioncore-pin-freeze")})]},e.id);var t})}):(0,u.jsx)("p",{className:"wppf-history-empty",children:(0,r.__)("No hay snapshots todavía para esta entrada.","sectioncore-pin-freeze")}):(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(q,{label:(0,r.__)("Modo de Captura","sectioncore-pin-freeze"),value:a,onChange:c,options:[{label:(0,r.__)("Editor State","sectioncore-pin-freeze"),value:"editor"},{label:(0,r.__)("Live Frontend","sectioncore-pin-freeze"),value:"live"}]}),"live"===a&&(0,u.jsx)("p",{className:"wppf-capture-selector-hint",children:(0,r.sprintf)(/* translators: %s: CSS selector */ /* translators: %s: CSS selector */
(0,r.__)("Selector configurado: %s","sectioncore-pin-freeze"),k)}),(0,u.jsxs)("div",{className:"wppf-post-actions",children:["live"===a&&(0,u.jsx)(B,{variant:"secondary",onClick:S,disabled:l||d,children:l?(0,r.__)("Capturando…","sectioncore-pin-freeze"):(0,r.__)("Fetch & Pin URL","sectioncore-pin-freeze")}),(0,u.jsx)(B,{variant:"primary",onClick:T,disabled:d||l,children:d?(0,r.__)("Guardando…","sectioncore-pin-freeze"):(0,r.__)("Pin HTML (Guardar)","sectioncore-pin-freeze")})]}),F?(0,u.jsx)(F,{value:e,onChange:i,language:"html",className:"wppf-post-code-editor"}):(0,u.jsx)(A,{label:(0,r.__)("Post Frozen HTML","sectioncore-pin-freeze"),value:e,onChange:i,rows:18,className:"wppf-post-code-editor-fallback"})]})})]})},G={wppf_is_pinned:{type:"boolean",default:!1},wppf_html:{type:"string",default:""},wppf_history:{type:"array",default:[]}},J=(0,t.createHigherOrderComponent)(e=>t=>(0,u.jsxs)(o.Fragment,{children:[(0,u.jsx)(e,{...t}),(0,u.jsx)(C,{...t})]}),"withBlockPinControl"),X=(0,t.createHigherOrderComponent)(e=>t=>{const o=Boolean(t?.attributes?.wppf_is_pinned),i="string"==typeof t?.attributes?.wppf_html?t.attributes.wppf_html:"",s=Boolean(i.trim());return o?(0,u.jsxs)("div",{className:"wppf-block-lock-wrapper"+(s?" wppf-block-lock-wrapper--has-preview":""),children:[(0,u.jsx)("div",{className:"wppf-block-lock-wrapper__source",children:(0,u.jsx)(e,{...t})}),s&&(0,u.jsx)("div",{className:"wppf-block-live-preview","aria-hidden":"true",children:(0,u.jsx)("div",{className:"wppf-block-live-preview__markup",dangerouslySetInnerHTML:{__html:i}})}),(0,u.jsx)(S,{label:(0,r.__)("Bloque pineado","sectioncore-pin-freeze"),actionLabel:(0,r.__)("Despinear bloque","sectioncore-pin-freeze"),onRequestSelect:()=>{t?.clientId&&(0,n.dispatch)("core/block-editor").selectBlock(t.clientId)},onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.blockUnpinConfirm||(0,r.__)("Este bloque está pineado. ¿Deseas despinearlo para editar?","sectioncore-pin-freeze");window.confirm(e)&&t.setAttributes({wppf_is_pinned:!1})}})]}):(0,u.jsx)(e,{...t})},"withPinOverlay");function K(){const{isPinned:e,setPinned:t}=H(),[n,i]=(0,o.useState)(null);return(0,o.useEffect)(()=>{i(document.querySelector(".editor-styles-wrapper"))},[]),(0,o.useEffect)(()=>(document.body.classList.toggle("wppf-post-is-pinned",e),()=>document.body.classList.remove("wppf-post-is-pinned")),[e]),e&&n?(0,o.createPortal)((0,u.jsx)(S,{className:"wppf-pin-overlay--post",label:(0,r.__)("Entrada/Página pineada","sectioncore-pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.postUnpinConfirm||(0,r.__)("Esta entrada está pineada. ¿Deseas despinearla para editar?","sectioncore-pin-freeze");window.confirm(e)&&t(!1)}}),n):null}(0,i.addFilter)("blocks.registerBlockType","sectioncore-pin-freeze/add-attributes",function(e){return e?.attributes||(e.attributes={}),{...e,attributes:{...e.attributes,...G}}}),(0,i.addFilter)("editor.BlockEdit","sectioncore-pin-freeze/block-pin-control",J),(0,i.addFilter)("editor.BlockListBlock","sectioncore-pin-freeze/block-pin-overlay",X),(0,s.registerPlugin)("sectioncore-pin-freeze-document-plugin",{render:function(){return(0,u.jsxs)(o.Fragment,{children:[(0,u.jsx)(V,{}),(0,u.jsx)(K,{})]})}})})();